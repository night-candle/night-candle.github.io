<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="网络协议基础入门, CS 宵烛 xiaozhu NightCandle 计算机 网络安全">
    <meta name="description" content="本文自顶而下、由业务到逻辑讲解网络协议相关知识，并分析如何在当下热门领域使用这些协议，如云计算、容器和微服务">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>网络协议基础入门 | 宵烛 Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/loading.css">
<meta name="generator" content="Hexo 5.1.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">宵烛 Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">宵烛 Blog</div>
        <div class="logo-desc">
            
            学生 | 虚假CTF选手 | 计算机菜鸟
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/27.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">网络协议基础入门</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%AE%B9%E5%99%A8/">
                                <span class="chip bg-color">容器</span>
                            </a>
                        
                            <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
                                <span class="chip bg-color">计算机网络</span>
                            </a>
                        
                            <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">
                                <span class="chip bg-color">网络协议</span>
                            </a>
                        
                            <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">
                                <span class="chip bg-color">云计算</span>
                            </a>
                        
                            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                <span class="chip bg-color">微服务</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E7%A7%91/" class="post-category">
                                计科
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-02-04
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-09-06
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    32 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言">前言</h2>
<p><strong>看似最枯燥、最基础的东西往往具有最长久的生命力</strong></p>
<p>​</p>
<p>​</p>
<h3 id="网络协议">网络协议</h3>
<ul>
<li>
<p>网络协议（Network Protocol），简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定</p>
</li>
<li>
<p>Internet 中涉及两个或多个通信远程实体的所有活动都由协议管理，协议规范了网络中所有信息发送和接收过程</p>
</li>
<li>
<p>协议规定了通信实体之间所交换消息的<strong>格式、意义、顺序</strong>以及针对收到信息或发生的事件所采取的<strong>动作</strong></p>
<blockquote>
<p><em>A protocol defines the format and the order of messages exchanged between two or more communicating entities, as well as the actions taken on the transmission and/or receipt of a message or other event.</em></p>
</blockquote>
</li>
</ul>
<h4 id="协议三要素">协议三要素</h4>
<ul>
<li>语法（<strong>Syntax</strong>）
<ul>
<li>数据与控制信息的结构或格式</li>
<li>信号电平</li>
</ul>
</li>
<li>语义（<strong>Semantics</strong>）
<ul>
<li>需要发出何种控制信息</li>
<li>完成何种动作以及做出何种响应</li>
</ul>
</li>
<li>时序（<strong>Timing</strong>）
<ul>
<li>事件顺序</li>
<li>速度匹配</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h3 id="网络分层">网络分层</h3>
<ul>
<li><a href="https://night-candle.github.io/2021/02/04/cs-network-socket/#OSI-%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82%E6%A8%A1%E5%9E%8B">OSI 概念模型</a></li>
<li>OSI 与 TCP/IP 模型对照</li>
</ul>
<img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210522-network-model.png" style="zoom: 80%;">
<ul>
<li>
<p>网络分层的优点：</p>
<ul>
<li>
<p>各层之间是独立的，某一层并不需要知道它下一层如何实现，而仅仅需要知道该层通过层间的接口所提供的服务</p>
</li>
<li>
<p>灵活性好，当任何一层发生变化时，只要<strong>层间接口关系保持不变，则在这层以上或以下各层均不受影响</strong></p>
<blockquote>
<p>传输层是 IPv4 或 IPv6，链路层是否仍使用1500字节的 MTU 对应用层没有影响</p>
</blockquote>
</li>
<li>
<p>结构上可分割开、易于实现和维护、能促进标准化工作</p>
</li>
</ul>
</li>
<li>
<p>层与层的关系：<strong>只要是在网络上的包都是完整的，可以有下层没上层，但不可有上层没下层</strong>，无论这个包经过哪些设备，它都是完整的，所谓二层设备、三层设备，都是这些设备上跑的程序不同而已，一个 HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包</p>
</li>
</ul>
<h3 id="架构设计">架构设计</h3>
<h4 id="设计原则">设计原则</h4>
<h5 id="关键架构属性">关键架构属性</h5>
<ul>
<li>性能 Performance：影响高可用的关键因素</li>
<li>可伸缩性 Scalability：支持部署可以互相交互的大量组件</li>
<li>简单性 Simplicity：易理解、易实现、易验证</li>
<li>可见性 Visiable：对两个组件间的交互进行监视或者仲裁的能力。如缓存、分层设计等</li>
<li>可移植性 Portability：在不同的环境下运行的能力</li>
<li>可靠性 Reliability：出现部分故障时，对整体影响的程度</li>
<li>可修改性 Modifiability：对系统作出修改的难易程度，由可进化性、可定制性、可扩展性、可配置性、可重用性构成</li>
</ul>
<h5 id="性能">性能</h5>
<ul>
<li>
<p>网络性能 <code>Network Performance</code></p>
<ul>
<li>
<p><code>Throughput</code> 吞吐量：小于等于带宽 bandwidth</p>
</li>
<li>
<p><code>Overhead</code> 开销：首次开销，每次开销</p>
</li>
</ul>
</li>
<li>
<p>用户感知到的性能 <code>User-perceived Performance</code></p>
<ul>
<li>
<p><code>Latency</code> 延迟：发起请求到接收到响应的时间</p>
</li>
<li>
<p><code>Completion</code> 完成时间：完成一个应用动作所花费的时间</p>
</li>
</ul>
</li>
<li>
<p>网络效率 <code>Network Efficiency</code></p>
<ul>
<li>重用缓存、减少交互次数、数据传输距离更近、COD</li>
</ul>
</li>
</ul>
<p>​</p>
<h5 id="可修改性">可修改性</h5>
<ul>
<li>
<p>可进化性 Evolvability：一个组件独立升级而不影响其他组件</p>
</li>
<li>
<p>可扩展性 Extensibility ：向系统添加功能，而不会影响到系统的其他部分</p>
</li>
<li>
<p>可定制性 Customizability ：临时性、定制性地更改某一要素来提供服务，不对常规客户产生影响</p>
</li>
<li>
<p>可配置性 Configurability ：应用部署后可通过修改配置提供新的功能</p>
</li>
<li>
<p>可重用性 Reusabilit ：组件可以不做修改在其他应用在使用</p>
</li>
</ul>
<p>​</p>
<h4 id="架构风格">架构风格</h4>
<h5 id="数据流风格">数据流风格</h5>
<ul>
<li>
<p>数据流风格 <code>Data-flow Styles</code></p>
</li>
<li>
<p>优点：简单性、可进化性、可扩展性、可配置性、可重用性</p>
</li>
<li>
<p>管道与过滤器（Pipe And Filter，PF）</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-pf.png" alt=""></p>
<ul>
<li>每个 Filter 都有输入端和输出端，只能从输入端读取数据，处理后再从输出端产生数据</li>
</ul>
</li>
<li>
<p>统一接口的管道与过滤器（Uniform Pipe And Filter，UPF）</p>
<ul>
<li>在 PF 上增加了统一接口的约束，所有 Filter 过滤器必须具备同样的接口</li>
</ul>
</li>
<li>
<p>两种架构对架构属性的影响</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-pf-and-upf.png" alt=""></p>
</li>
<li>
<p>例如：协议分层</p>
</li>
</ul>
<h5 id="复制风格">复制风格</h5>
<ul>
<li>
<p>复制风格 <code>Replication Styles</code></p>
</li>
<li>
<p>优点：用户可察觉的性能、可伸缩性，网络效率、可靠性也可以提到提升</p>
</li>
<li>
<p>复制仓库（Replicated Repository, RR）</p>
<ul>
<li>多个进程提供相同的服务，通过反向代理对外提供集中服务</li>
<li>例如：MySQL 冷热备份</li>
</ul>
</li>
<li>
<p>缓存 $</p>
<ul>
<li>RR 的变体，通过复制请求的结果，为后续请求复用</li>
</ul>
</li>
<li>
<p>两种架构对架构属性的影响</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-rr-and-cache.png" alt=""></p>
</li>
</ul>
<h5 id="分层风格">分层风格</h5>
<ul>
<li>
<p>分层风格 <code>Hierarchical Styles</code></p>
</li>
<li>
<p>优点：简单性、可进化性、可伸缩性</p>
</li>
<li>
<p>客户端服务器（Client-Server，CS）</p>
<ul>
<li>由 Client 触发请求，Server 监听到请求后产生响应，Client 一直等待收到响应后，会话结束</li>
<li>分离关注点隐藏细节，良好的简单性、可伸缩性、可进化性</li>
<li>示例：<a href="https://night-candle.github.io/2021/02/04/cs-network-socket/#1-1-1-%E5%AE%A2%E6%88%B7%E7%AB%AF-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B">客户端 - 服务器网络模型</a></li>
</ul>
</li>
<li>
<p>分层系统（Layered System，LS）</p>
<ul>
<li>每一层为其之上的层服务，并使用在其之下的层所提供的服务</li>
<li>例如 TCP/IP</li>
</ul>
</li>
<li>
<p>分层客户端服务器（Layered Client-Server，LCS）</p>
<ul>
<li>LS+CS</li>
<li>例如正向代理和反向代理，从空间上分为外部层与内部层</li>
</ul>
</li>
<li>
<p>无状态、客户端服务器（Client-Stateless-Server，CSS）</p>
<ul>
<li>
<p>基于 CS，服务器上不允许有session state会话状态</p>
</li>
<li>
<p>提升了可见性、可伸缩性、可靠性，但重复数据导致降低网络性能</p>
</li>
</ul>
</li>
<li>
<p>缓存、无状态、客户端服务器（Client-Cache-Stateless-Server，C$SS）</p>
<ul>
<li>提升性能</li>
</ul>
</li>
<li>
<p>分层、缓存、无状态、客户端服务器（Layered-Client-Cache-Stateless-Server，LC$SS）</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-LC%24SS.png" alt=""></p>
</li>
<li>
<p>远程会话（<strong>Remote Session</strong>，RS）</p>
<ul>
<li>CS 变体，服务器保存应用状态（Application state）</li>
<li>可伸缩性、可见性差</li>
<li>例如：FTP</li>
</ul>
</li>
<li>
<p>远程数据访问（<strong>Remote Data Access</strong>，RDA）</p>
<ul>
<li>
<p>CS 变体， Application state 应用状态同时分布在客户端与服务器</p>
</li>
<li>
<p>巨大的数据集有可能通过迭代而减少</p>
</li>
<li>
<p>简单性、可伸缩性差</p>
</li>
<li>
<p>例如：SQL 访问数据库</p>
</li>
</ul>
</li>
<li>
<p>对架构属性的影响</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-hierarchical-styles.png" alt=""></p>
</li>
</ul>
<h5 id="移动代码风格">移动代码风格</h5>
<ul>
<li>
<p>移动代码风格 <code>Mobile Code Styles</code>，执行的代码可移动</p>
</li>
<li>
<p>优点：可移植性、可扩展性、网络效率</p>
</li>
<li>
<p>虚拟机（Virtual Machine，VM）</p>
<ul>
<li>分离指令与实现</li>
</ul>
</li>
<li>
<p>远程求值（Remote Evaluation，REV）</p>
<ul>
<li>基于 CS 的 VM，将代码发送至服务器执行</li>
<li>例如：JS</li>
</ul>
</li>
<li>
<p>按需代码（Code on Demand，COD）</p>
<ul>
<li>
<p>服务器在响应中发回处理代码，在客户端执行</p>
</li>
<li>
<p>优秀的可扩展性和可配置性，提升用户可察觉性能和网络效率</p>
</li>
</ul>
</li>
<li>
<p>分层、按需代码、缓存、无状态、客户端服务器</p>
<p>（Layered-Code-on-Demand-Client-Cache-Stateless-Server，LCODC$SS）</p>
<ul>
<li>LC$SS+COD</li>
</ul>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-LC%24SS%2BCOD.png" alt="统一接口的 LC$SS+COD"></p>
</li>
<li>
<p>移动代理（Mobile Agent，MA）</p>
<ul>
<li>相当于 REV+COD</li>
</ul>
</li>
<li>
<p>对架构属性的影响</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-mobile-code-styles.png" alt=""></p>
</li>
</ul>
<h5 id="点对点风格">点对点风格</h5>
<ul>
<li>
<p>点对点风格 <code>Peer-to-Peer Styles</code></p>
</li>
<li>
<p>优点：可进化性、可重用性、可扩展性、可配置性</p>
</li>
<li>
<p>Event-based Integration，EBI：</p>
<ul>
<li>
<p>基于事件集成系统，如由类似 Kafka 这样的消息系统 + 分发订阅来消除耦合</p>
</li>
<li>
<p>优秀的可重用性、可扩展性、可进化性</p>
</li>
<li>
<p>缺乏可理解性，收到一条消息不知道是哪个订阅产生的</p>
</li>
<li>
<p>由于消息广播等因素造成的消息风暴，可伸缩性差</p>
</li>
</ul>
</li>
<li>
<p>Chiron-2，C2</p>
<ul>
<li>参见论文《A Component- and Message-Based Architectural Style for GUI Software》</li>
<li>相当于 EBI+LCS，控制了消息的方向</li>
</ul>
</li>
<li>
<p>Distributed Objects，DO</p>
<ul>
<li>组件结对交互</li>
</ul>
</li>
<li>
<p>Brokered Distributed Objects，BDO</p>
<ul>
<li>引入名字解析组件来简化 DO，例如 CORBA</li>
</ul>
</li>
<li>
<p>对架构属性的影响</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220606-peer-to-peer-styles.png" alt=""></p>
</li>
</ul>
<h2 id="应用层">应用层</h2>
<h3 id="HTTP">HTTP</h3>
<p>HTTP 协议（<code>Hypertext Transfer Protocol</code>）</p>
<p>  <em>a stateless application-level request/response protocol that uses extensible semantics and self-descriptive message payloads for flexible interaction with network-based hypertext information systems</em>（RFC7230）</p>
<p>  一种<strong>无状态</strong>的、应用层的、以<strong>请求/应答方式</strong>运行的协议，它使用<strong>可扩展的语义和自描述消息格式</strong>，与基于网络的<strong>超文本</strong>信息系统灵活的互动</p>
<p>​</p>
<h4 id="HTTP-1-的设计">HTTP/1 的设计</h4>
<h5 id="HTTP-解决了什么问题？">HTTP 解决了什么问题？</h5>
<ul>
<li>
<p><strong>Form Follows Function</strong>：HTTP 协议为什么是现在这个样子？</p>
<blockquote>
<p>Web’s major goal was to be a shared information space through which people and machines could communicate. ——<em>Tim Berners Lee</em></p>
</blockquote>
</li>
<li>
<p>解决 WWW 信息交互必须面对的需求</p>
<ul>
<li>低门槛</li>
<li>可扩展性：巨大的用户群体，超长的寿命</li>
<li>分布式系统下的 Hypermedia：大粒度数据的网络传输</li>
<li>Internet 的规模
<ul>
<li>无法控制的 scalability：不可预测的负载、非法格式的数据、恶意消息和客户端不能保持所有服务器信息、服务器不能保持多个请求间的状态信息</li>
<li>独立的组件部署：新老组件并存</li>
</ul>
</li>
<li>向前兼容：1993 年起 HTTP0.9\1.0（1996）已经被广泛使用</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h5 id="REST-架构">REST 架构</h5>
<ul>
<li>
<p><em>Roy Thomas Fielding</em> 在 2000 年发布指导 HTTP/1.1 规范制订的论文《Architectural Style and the Design of Network-based Software Architectures》，即常说的 Representational State Transfer（REST）架构</p>
</li>
<li>
<p>风格演化</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210522-evolution.png" alt="推导 REST 架构"></p>
<blockquote>
<p>REST：分层、按需代码、缓存、无状态、客户端服务器、统一接口（URL）</p>
</blockquote>
</li>
<li>
<p>REST 架构下 Web</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210522-rest.png" alt=""></p>
</li>
</ul>
<h4 id="协议通用规则">协议通用规则</h4>
<h5 id="消息格式">消息格式</h5>
<p>基于<strong>ABNF</strong>语义定义的 HTTP 消息格式</p>
<p><strong>HTTP-message = <font color="#ff8378">start-line</font> *( <font color="#2abfb0">header-field</font> CRLF ) CRLF [ <font color="#83b2cc">message-body</font> ]</strong></p>
<ul>
<li><font color="#ff8378"><strong>start-line</strong></font> = request-line / status-line
<ul>
<li>request-line = method SP request-target SP HTTP-version CRLF</li>
<li>status-line = HTTP-version SP status-code SP reason-phrase CRLF</li>
</ul>
</li>
<li><font color="#2abfb0"><strong>header-field</strong></font> = field-name “:” OWS field-value OWS
<ul>
<li>
<p>OWS = *( SP / HTAB )</p>
</li>
<li>
<p>field-name = token</p>
</li>
<li>
<p>field-value =  *( field-content / obs-fold ）</p>
</li>
</ul>
</li>
<li><font color="#83b2cc"><strong>message-body</strong></font> = *OCTET</li>
</ul>
<blockquote>
<p><code>ABNF</code> <strong>扩充巴科斯 - 瑙尔范式</strong>：定义语法的元语言</p>
<ul>
<li>
<p>操作符</p>
<ul>
<li>空白字符：用来分隔定义中的各个元素
<ul>
<li>e.g.method SP request-target SP HTTP-version CRLF</li>
</ul>
</li>
<li>选择 <strong>/</strong>：表示多个规则都是可供选择的规则
<ul>
<li>e.g.start-line = request-line / status-line</li>
</ul>
</li>
<li>值范围 <strong>%c##-##</strong>
<ul>
<li>e.g.OCTAL = “0” / “1” / “2” / “3” / “4” / “5” / “6” / “7” 与 OCTAL = %x30-37 等价</li>
</ul>
</li>
<li>序列组合 <strong>()</strong>：将规则组合起来，视为单个元素</li>
<li>不定量重复 <strong>m*n</strong>
<ul>
<li>e.g.*元素表示零个或更多元素： *( header-field CRLF )</li>
<li>e.g.1* 元素表示一个或更多元素，2*4 元素表示两个至四个元素</li>
</ul>
</li>
<li>可选序列 <strong>[]</strong>
<ul>
<li>e.g.[ message-body ]</li>
</ul>
</li>
</ul>
</li>
<li>
<p>核心规则</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210522-core-rules.png" alt=""></p>
</li>
</ul>
</blockquote>
<ul>
<li>
<p>报文示例</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210522-message-instance.png" alt=""></p>
</li>
</ul>
<h5 id="URI">URI</h5>
<ul>
<li>
<p>URL：<code>Uniform Resource Locator</code>，表示资源的位置， 期望提供查找资源的方法  （RFC1738）</p>
</li>
<li>
<p>URN：<code>Uniform Resource Name</code>，期望为资源提供持久的、位置无关的标识方式，并允许简单地将多个命名空间映射到单个URN命名空间 （RFC2141）</p>
<ul>
<li>e.g. <strong>磁力链接</strong></li>
</ul>
</li>
<li>
<p><strong>URI</strong>：<code>Uniform Resource Identifier</code>，用以区分资源，<strong>是 URL 和 URN 的超集</strong>，用以取代 URL 和 URN 概念 （RFC1630、<a target="_blank" rel="noopener" href="https://www.ietf.org/rfc/rfc3986.txt">RFC3986</a>）</p>
<ul>
<li>
<p>Resource 资源</p>
<ul>
<li>可以是图片、文档，也可以是不能通过互联网访问的实体，例如人、公司，也可以是抽象的概念，例如亲属关系或者数字符号</li>
<li>一个资源可以有多个 URI</li>
</ul>
</li>
<li>
<p>Identifier 标识符</p>
<ul>
<li>将当前资源与其他资源区分开的名称</li>
</ul>
</li>
<li>
<p>Uniform 统一</p>
<ul>
<li>允许不同种类的资源在同一上下文中出现</li>
<li>对不同种类的资源标识符可以使用同一种语义进行解读</li>
<li>引入新标识符时，不会对已有标识符产生影响</li>
<li>允许同一资源标识符在不同的、internet 规模下的上下文中出现</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>​</p>
<ul>
<li>
<p><strong>URI 组成</strong>：schema、user information、host、port、path、query、fragment</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210526-URI.png" alt=""></p>
</li>
<li>
<p>URI 编码</p>
<ul>
<li>对可能产生歧义性的数据编码（不在 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ASCII">ASCII</a> 码范围内字符；ASCII 码中不可显示字符；URI 中规定的保留字符；不安全字符）</li>
<li>百分号编码的方式</li>
<li>非 ASCII 码字符：建议先 UTF8 编码，再 US-ASCII 编码</li>
<li>对 URI 合法字符，编码与不编码是等价的</li>
</ul>
</li>
</ul>
<p>​</p>
<h5 id="方法">方法</h5>
<p><strong>常见方法（RFC7231）</strong></p>
<ul>
<li>
<p><strong>GET</strong>：主要的获取信息方法，大量的性能优化都针对该方法，幂等方法</p>
</li>
<li>
<p>HEAD：类似 GET 方法，但服务器不发送 BODY，用以获取 HEAD 元数据，幂等方法</p>
</li>
<li>
<p><strong>POST</strong>：常用于提交 HTML FORM 表单、新增资源等</p>
</li>
<li>
<p>PUT：更新资源，带条件时是幂等方法</p>
</li>
<li>
<p>DELETE：删除资源，幂等方法</p>
</li>
<li>
<p>CONNECT：建立 tunnel 隧道</p>
</li>
<li>
<p>OPTIONS：显示服务器对访问资源支持的方法，幂等方法</p>
</li>
<li>
<p><s>TRACE</s>：回显服务器收到的请求，用于定位问题，有安全风险</p>
</li>
</ul>
<p>​</p>
<p><strong>用于文档管理的 WEBDAV 方法（RFC2518）</strong></p>
<ul>
<li>
<p>PROPFIND：从 Web 资源中检索以 XML 格式存储的属性，它也被重载以允许一个检索远程系统的集合结构（也叫目录层次结构）</p>
</li>
<li>
<p>PROPPATCH：在单个原子性动作中更改和删除资源的多个属性</p>
</li>
<li>
<p>MKCOL：创建集合或者目录</p>
</li>
<li>
<p>COPY：将资源从一个 URI 复制到另一个 URI</p>
</li>
<li>
<p>MOVE：将资源从一个 URI 移动到另一个 URI</p>
</li>
<li>
<p>LOCK：锁定一个资源。WebDAV 支持共享锁和互斥锁</p>
</li>
<li>
<p>UNLOCK：解除资源的锁定</p>
</li>
</ul>
<p>​</p>
<p>​</p>
<h5 id="响应码">响应码</h5>
<ul>
<li>
<p>响应码规范：RFC6585、RFC7231</p>
</li>
<li>
<p><code>1xx</code>：请求已接收到，需要进一步处理才能完成，HTTP1.0 不支持</p>
<ul>
<li><strong>100 Continue</strong>：上传大文件前使用，由客户端发起请求中携带 <code>Expect: 100-continue</code> 头部触发</li>
<li><strong>101 Switch Protocols</strong>：协议升级使用，由客户端发起请求中携带 <code>Upgrade:</code> 头部触发</li>
</ul>
</li>
<li>
<p><code>2xx</code>：成功处理请求</p>
<ul>
<li>
<p><strong>200 OK</strong>：成功返回响应</p>
</li>
<li>
<p><strong>201 Created</strong>：有新资源在服务器端被成功创建</p>
</li>
<li>
<p><strong>202 Accepted</strong>：服务器接收并开始处理请求，但请求未处理完成</p>
</li>
<li>
<p><strong>204 No Content</strong>：成功执行了请求且不携带响应包体，并暗示客户端无需更新当前的页面视图</p>
</li>
<li>
<p><strong>205 Reset Content</strong>：成功执行了请求且不携带响应包体，同时指明客户端需要更新当前页面视图（画图）</p>
</li>
<li>
<p><strong>206 Partial Content</strong>：使用 range 协议时返回部分响应内容时的响应码（断点续传）</p>
</li>
</ul>
</li>
<li>
<p><code>3xx</code>：重定向使用 Location 指向的资源或者缓存中的资源，在 RFC2068 中规定客户端重定向次数不应超过 5 次，以防止死循环</p>
<ul>
<li><strong>301 Moved Permanently</strong>：资源永久性的重定向到另一个 URI 中</li>
<li><strong>302 Found</strong>：资源临时的重定向到另一个 URI 中</li>
<li><strong>303 See Other</strong>：重定向到其他资源，常用于 POST/PUT 等方法的响应中</li>
<li><strong>304 Not Modified</strong>：当客户端拥有可能过期的缓存时，会携带缓存的标识 etag、时间等信息询问服务器缓存是否仍可复用，而304是告诉客户端可以复用缓存</li>
</ul>
</li>
<li>
<p><code>4xx</code>：客户端出现错误，服务器无法处理请求</p>
<ul>
<li>
<p><strong>403 Forbidden</strong>：服务器理解请求的含义，但没有权限执行此请求</p>
</li>
<li>
<p><strong>404 Not Found</strong>：服务器没有找到对应的资源</p>
</li>
<li>
<p><strong>408 Request Timeout</strong>：服务器接收请求超时</p>
</li>
<li>
<p><strong>415 Unsupported Media Type</strong>：上传的文件类型不被服务器支持</p>
</li>
<li>
<p><strong>416 Range Not Satisfiable</strong>：无法提供 range 请求中指定的那段包体</p>
</li>
</ul>
</li>
<li>
<p><code>5xx</code>：服务器端出现错误，服务器处理请求出错</p>
<ul>
<li><strong>501 Not Implemented</strong>：服务器不支持实现请求所需要的功能</li>
<li><strong>502 Bad Gateway</strong>：代理服务器无法获取到合法响应</li>
<li><strong>503 Service Unavailable</strong>：服务器资源尚未准备好处理当前请求</li>
<li><strong>504 Gateway Timeout</strong>：代理服务器无法及时的从上游获得响应</li>
</ul>
</li>
</ul>
<h4 id="连接与消息的路由">连接与消息的路由</h4>
<h5 id="短连接与长连接">短连接与长连接</h5>
<p>Host 头部与消息的路由</p>
<h4 id="内容协商与传输">内容协商与传输</h4>
<p>每个 URI 指向的资源可以是任何事物，可以有多种不同的表述，例如一份文档可以有不同语言的翻译、不同的媒体格式、可以针对不同的浏览器提供不同的压缩编码等。</p>
<h4 id="Cookie-的设计与问题">Cookie 的设计与问题</h4>
<h4 id="缓存的控制">缓存的控制</h4>
<p>​</p>
<p>​</p>
<p>​</p>
<h3 id="WebSocket">WebSocket</h3>
<blockquote>
<p>支持服务器推送消息</p>
</blockquote>
<p>WebSocket是基于TCP的应用层协议，用于在C/S架构的应用中实现<strong>双向通信</strong>。RFC6455（2011.12）</p>
<p>• 双向通讯的优劣？</p>
<p>• 如何管理会话？</p>
<p>• 如何维持长连接？</p>
<p>• 兼容 HTTP 协议</p>
<p>• 端口复用</p>
<p>• 支持扩展</p>
<p>• 如 permessage-deflate 扩展</p>
<p>建立会话<br>
• 消息传输<br>
• 心跳<br>
• 关闭会话</p>
<p>​</p>
<p>​</p>
<p>​</p>
<h3 id="HTTP-2-0">HTTP/2.0</h3>
<p>​</p>
<p>​</p>
<p>​</p>
<h3 id="TLS-SSL">TLS/SSL</h3>
<blockquote>
<p>应用层的安全基础设施</p>
</blockquote>
<h2 id="传输层">传输层</h2>
<h3 id="TCP">TCP</h3>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210127-tcp-development-history.png" alt="发展历史"></p>
<h4 id="建立连接">建立连接</h4>
<h4 id="传输数据">传输数据</h4>
<h4 id="拥塞控制">拥塞控制</h4>
<h4 id="关闭连接">关闭连接</h4>
<h3 id="UDP">UDP</h3>
<p>​</p>
<p>​</p>
<h2 id="网络层">网络层</h2>
<p>​</p>
<h3 id="IP-协议">IP 协议</h3>
<h4 id="IP地址">IP地址</h4>
<ul>
<li>
<p><strong>IP 地址是一个网卡在网络世界的通讯地址</strong>，相当于现实世界的门牌号码，有定位功能</p>
</li>
<li>
<p>查看 IP 地址：<code>ifconfig</code>、 <code>ip addr</code>（Linux）</p>
<blockquote>
<p>大多数时候这两个命令系统自带，如果登录进入一个被裁剪过的非常小的 Linux 系统中，既没有 ifconfig 命令，也没有 ip addr 命令，可以自行安装 <strong>net-tools</strong> 和 <strong>iproute2</strong> 工具；net-tools 起源于BSD，自2001年起 Linux 社区已经对其停止维护，而 iproute2 旨在取代 net-tools 并提供了一些新功能</p>
<p>net-tools 通过 <code>procfs(/proc)</code> 和 <code>ioctl</code> 系统调用去访问和改变内核网络配置；iproute2 则通过 <code>netlink</code> 套接字接口与内核通讯</p>
</blockquote>
</li>
</ul>
<p>​</p>
<p>​</p>
<h5 id="IP-地址分类">IP 地址分类</h5>
<ul>
<li>
<p>32 位的 IP 地址被分成了 5 类，A、B、C 类主要分两部分，前面一部分是网络号，后面一部分是主机号</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-ip-classful-addressing.png" alt=""></p>
</li>
<li>
<p>A、B、C 三类地址能包含的主机数量</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-number-of-addresses.png" alt=""></p>
<p><strong>问题</strong>： C 类地址能包含的最大主机数量实在太少了，只有 254 个，而 B 类地址能包含的最大主机数量又太多了，6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模（<strong>无类型域间选路</strong>）</p>
</li>
<li>
<p>公有/私有 IP 地址</p>
<ul>
<li>
<p>上面的表格最右列是私有 IP 地址段，平时看到的数据中心、办公室、家里或学校的 IP 地址一般都是私有 IP 地址段，因为这些地址允许组织内部的 IT 人员自己管理、自己分配，而且可以重复，但是出了内网就需要使用公有 IP 地址</p>
</li>
<li>
<p>表格中的 <strong>192.168.0.x</strong> 是最常用的私有 IP 地址，一般家中上网设备不会超过 256 个，整个网络里面的第一个地址 <strong>192.168.0.1</strong> 往往就是私有网络的出口地址</p>
</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h5 id="无类型域间选路">无类型域间选路</h5>
<ul>
<li>CIDR 将 IP 地址一分为二，前面是网络号，后面是主机号，例如 <strong>10.100.122.2/24</strong> 这种地址表示形式就是 CIDR，32 位中前 24 位是网络号，后 8 位是主机号</li>
<li>伴随 CIDR 存在的，一个是广播地址，另一个是子网掩码，将子网掩码和 IP 地址按位计算 AND 就可得到网络号</li>
</ul>
<p>​</p>
<p>​</p>
<h5 id="动态主机配置协议">动态主机配置协议</h5>
<ul>
<li>
<p>需要一个自动配置的协议，解决客户端的机器每次使用都要配置 IP 地址的问题</p>
</li>
<li>
<p>动态主机配置协议（DHCP）主要是用来给客户租用 IP 地址，网络管理员只需要配置一段共享的 IP 地址，每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好，用完了还回去</p>
</li>
<li>
<p>DHCP 协议能给客户推荐 <code>PXE</code> 帮助安装操作系统，在云计算领域大有用处</p>
</li>
</ul>
<p>​</p>
<p>​</p>
<h3 id="ICMP">ICMP</h3>
<ul>
<li>
<p>ICMP（Internet Control Message Protocol）即互联网控制报文协议，是一种<strong>基于 IP 协议</strong>的控制协议</p>
</li>
<li>
<p>网络包在异常复杂的网络环境中传输时，常常会遇到各种各样的问题，当遇到问题时要传出消息来报告情况，调整传输策略</p>
</li>
<li>
<p><strong>ICMP 报文封装在 IP 包里面</strong>，因为传输指令的时候需要源地址和目标地址</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210405-icmp.png" alt="ICMP 报文"></p>
</li>
<li>
<p>ICMP 在 IP 报文后加入了新的内容</p>
<ul>
<li>
<p>类型：ICMP 报文有很多的类型，不同的类型有不同的代码，其中 ping 的请求类型为 8（主动请求），应答为 0</p>
</li>
<li>
<p>代码：进一步划分 ICMP 的类型, 用来查找产生错误的原因</p>
</li>
<li>
<p>校验和：用于检查错误的数据</p>
</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h4 id="查询报文类型">查询报文类型</h4>
<ul>
<li>
<p>例如 ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议</p>
</li>
<li>
<p>ping 的主动请求称为 <strong>ICMP ECHO REQUEST</strong>；主动请求的回复称为 <strong>ICMP ECHO REPLY</strong>，比起原生的 ICMP，这里面多了两个字段：标识符、顺序号</p>
</li>
<li>
<p>在选项数据中，ping 还会在报文的数据部分插入发送时间，来计算往返时间，说明路程的长短</p>
</li>
</ul>
<p>​</p>
<p>​</p>
<h4 id="差错报文类型">差错报文类型</h4>
<ul>
<li>
<p>异常情况发起的，来报告发生了不好的事情，对应 ICMP 的<strong>差错报文类型</strong>，差错报文的结构前面还是 IP，ICMP 的前 8 字节不变，后面则跟上出错的那个 IP 包的 IP 头和 IP 正文的前 8 个字节</p>
</li>
<li>
<p>终点不可达为 3，源抑制为 4，超时为 11，重定向为 5</p>
<ul>
<li>
<p><strong>源站抑制</strong>，也就是让源站放慢发送速度</p>
</li>
<li>
<p><strong>时间超时</strong>，也就是超过网络包的生存时间还是没到</p>
</li>
<li>
<p><strong>路由重定向</strong>，也就是让下次发给另一个路由器</p>
</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h4 id="Traceroute">Traceroute</h4>
<ul>
<li>Traceroute 会使用 ICMP 的规则故意制造一些能够产生错误的场景</li>
<li><strong>故意设置特殊的 TTL ，来追踪去往目的地时沿途经过的路由器</strong>
<ul>
<li>发送一份TTL字段为1的 UDP 数据包给目的主机，处理这个数据包的第一个路由器会给源主机发送一个 ICMP 报文（时间<strong>超时</strong>，报文中包含了第一个路由器的地址），然后发送一个TTL为2的数据报来得到第二个路由器的地址，继续这个过程，直至这个数据报到达目的主机</li>
<li>有的路由器不会回 ICMP，这也是 Traceroute 一个公网的地址看不到中间路由的原因</li>
<li>停止准则：选择目的端口号为一个不可能使用的端口号，当该数据报到达目的主机，将返回一份<strong>端口不可达</strong>错误 ICMP 报文（type=3,code=3），如果数据报没有到达，则可能是超时</li>
</ul>
</li>
<li><strong>故意设置不分片，从而确定路径的 MTU</strong>
<ul>
<li>首先发送分组，并设置不分片标志，发送的第一个分组的长度正好与出口 MTU 相等</li>
<li>如果中间遇到窄的关口会被卡住，会发送 ICMP 网络差错包，类型为<strong>需要进行分片但设置了不分片位</strong>，每次收到不能分片差错时就减小分组的长度，直到到达目标主机</li>
</ul>
</li>
</ul>
<p>​</p>
<p>​</p>
<h2 id="链路层">链路层</h2>
<p>​</p>
<h3 id="ARP">ARP</h3>
<blockquote>
<p>已知 IP 地址，求 MAC 地址的协议</p>
</blockquote>
<ul>
<li>
<p>在一个局域网里面，当知道了 IP 地址，不知道 MAC 怎么办呢？靠广播，谁是这个 IP 谁来回答</p>
<img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-arp.png" style="zoom:50%;">
</li>
<li>
<p>报文格式</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-arp-message.png" alt=""></p>
</li>
<li>
<p>为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存；机器会不断地上线下线，IP 也可能会变，所以缓存过一段时间会过期</p>
</li>
</ul>
<p>​</p>
<blockquote>
<p>  RARP 协议：已知 MAC 求 IP</p>
<ul>
<li>
<p>无盘工作站无法持久化IP地址到本地，但有网卡，所以可以用RARP协议来获取IP地址</p>
</li>
<li>
<p>RARP可以用于局域网管理员想指定机器IP，又不想每台机器去设置静态IP的情况，可以在RARP服务器上配置MAC和IP对应的ARP表</p>
</li>
</ul>
</blockquote>
<p>​</p>
<h3 id="VLAN">VLAN</h3>
<ul>
<li>
<p>交换机数目多会面临<strong>隔离问题</strong>，可以通过 VLAN 形成<strong>虚拟局域网</strong>，从而解决<strong>广播问题和安全问题</strong></p>
</li>
<li>
<p>交换机可以设置交换机每个口所属的 VLAN，且可以重新设置</p>
</li>
<li>
<p>交换机区分局域网只需要在原来的二层的头上加一个 <code>TAG</code>，其中有一个12 位的 <code>VLAN ID</code>（<strong>可以划分 4096 个 VLAN</strong>），如果交换机支持 VLAN ，取下二层的头时，就能够识别 VLAN ID</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-vlan.png" alt=""></p>
</li>
<li>
<p>只有<strong>相同 VLAN 的包，才会互相转发</strong>，不同 VLAN 的包是看不到的</p>
</li>
<li>
<p>对于支持 VLAN 的交换机，交换机之间可以使用<strong>Trunk 口</strong>连接，它可以转发属于任何 VLAN 的口</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20210208-trunk.png" alt=""></p>
<p>​</p>
</li>
</ul>
<h3 id="STP">STP</h3>
<ul>
<li>
<p>当交换机的数目越来越多时，交换机之间为了冗余、带宽提升、或错误连接难免会产生一个封闭的物理环路，遭遇<strong>环路问题</strong>，产生广播风暴（网络包迷路，一个包转来转去，每台机器都会发广播包，交换机转发也会复制广播包，当广播包越来越多的时候，路会越来越堵）这就需要使用 <strong>STP 协议，将有环路的图变成没有环路的树</strong>，将物理上存在环路的网络通过算法在逻辑上阻塞一些端口</p>
</li>
<li>
<p>概念</p>
<ul>
<li><strong>Root Bridge</strong>，<strong>根交换机</strong>，是某棵树的老大</li>
<li><strong>Designated Bridges</strong>，<strong>指定交换机</strong>，就是一棵树的树枝</li>
<li><strong>Bridge Protocol Data Units（BPDU）</strong>，<strong>网桥协议数据单元</strong>
<ul>
<li>交换机相连的时候，就需要“相互比较实力”</li>
<li>BPDU 只有根交换机能发</li>
</ul>
</li>
<li><strong>Priority Vector</strong>，<strong>优先级向量</strong>
<ul>
<li>[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]</li>
<li>先看 Root Bridge ID，再比 Root Path Cost，也即距离老大的距离，最后比 Bridge ID，拿自己的本事比</li>
</ul>
</li>
</ul>
</li>
<li>
<p>生成树协议运行生成树算法过程可以归纳为以下三个步骤：</p>
<ol>
<li>选择根交换机</li>
<li>选择根端口</li>
<li>选择指定端口</li>
</ol>
</li>
<li>
<p>STP缺点：一个是某个交换机状态发生变化的时候，整个树需要重新构建；被破开的环的链路被浪费</p>
</li>
</ul>
<p>​</p>
<p>​</p>
<h2 id="无线网络">无线网络</h2>
<h3 id="蜂窝因特网接入">蜂窝因特网接入</h3>
<h4 id="蜂窝网体系结构概述">蜂窝网体系结构概述</h4>
<h5 id="2G：语音与电话网连接">2G：语音与电话网连接</h5>
<ul>
<li>
<p>2G 时代上网使用的不是 IP 网络而是电话网络，即公共交换电话网（PSTN），走模拟信号</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220903-2g.jpg" alt=""></p>
</li>
<li>
<p>术语蜂窝是指由一个蜂窝网覆盖的区域被分成许多称为小区（cell）的地理覆盖区域，每个小区包含一个收发基站（BTS）负责向其小区内的移动站点发送接收信号</p>
</li>
<li>
<p>无线通信的服务端是基站子系统（BSS），基站子系统分两部分，一部分对外提供无线通信，叫做基站收发信台（BTS，Base Transceiver Station），另一部分对内连接有线网络，叫作基站控制器（BSC，Base Station Controller），基站收发信台通过无线收到数据后转发给基站控制器，这部分属于无线的部分，统称为无线接入网（RAN，Radio Access Network）</p>
</li>
<li>
<p>基站控制器通过有线网络，连接到提供手机业务的运营商的数据中心，这部分称为核心网（CN，Core Network），这部分还是主要提供手机业务，是手机业务的有线部分</p>
</li>
<li>
<p>核心网的入口是移动业务交换中心（MSC），通过网关（GMSC）连接核心网和电话网络，在用户鉴别和账户管理（决定是否允许某个移动设备与蜂窝网络连接）以及呼叫建立和切换中，移动交换中心起着决定性的作用</p>
<ul>
<li>
<p>鉴权中心（AUC）和设备识别寄存器（EIR）主要是负责安全性的</p>
</li>
<li>
<p>访问位置寄存器（VLR）是看你目前在的地方，归属位置寄存器（HLR）是看你的号码归属地</p>
</li>
</ul>
</li>
<li>
<p>2.5G 在原来电路交换的基础上，加入了分组交换业务，支持 Packet 的转发，从而支持 IP 网络</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220903-2.5g.jpg" alt=""></p>
</li>
</ul>
<h5 id="3G：将因特网扩展到蜂窝用户">3G：将因特网扩展到蜂窝用户</h5>
<ul>
<li>
<p>3G 核心蜂窝数据网将无线电接入网连接到公共因特网，不去触动现有核心 GSM 蜂窝语音网，增加与现有蜂窝语音网平行的附加蜂窝数据功能</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220903-3g.png" alt=""></p>
</li>
<li>
<p>3G 核心网中有两类节点：服务 GPRS 支持节点（SGSN，Service GPRS Supported Node）和网关 GPRS 支持节点（GGSN，Gateway GPRS Supported Node）</p>
<blockquote>
<p>GPRS 表示通用分组无线服务，这是一种在 2G 网络中的早期蜂窝数据服务，这里讨论的是在 3G 网络中 GPRS 的演化版本</p>
</blockquote>
</li>
<li>
<p>SGSN 负责向位于其连接的无线接入网中的移动节点收发数据报；与该区域蜂窝语音网的 MSC 进行交互，提供用户认证和切换，维护活跃移动节点的位置信息；执行移动节点和 GGSN 间的数据报转发</p>
</li>
<li>
<p>GGSN 起着网关的作用，将多个SGSN连接到更大的因特网</p>
</li>
<li>
<p>连接核心网的是无线网络控制器（RNC，Radio Network Controller），通常控制几个小区的收发基站，RNC 既通过 MSC 与电路交换蜂窝语音网连接，又通过 SGSN 与分组交换的因特网连接</p>
<blockquote>
<p>3G <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/UMTS">UMTS</a> 的正式用语称为一个 Node B</p>
</blockquote>
</li>
</ul>
<h5 id="4G：LTE">4G：LTE</h5>
<ul>
<li>
<p>3GPP 提出的 4G 长期演进互联网（LTE，Long-Term Evolution）标准有两个重要的创新：<strong>全 IP 核心网</strong>和加强的无线接入网</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220903-4g.png" alt=""></p>
</li>
<li>
<p>无线接入网与全 IP 核心网之间清晰分离，核心网实现了控制面和数据面的分离</p>
<ul>
<li>承载用户数据的 IP 数据报经过内部 4G IP 网络，在用户（UE）和网关（P-GW）之间转发</li>
</ul>
</li>
<li>
<p>4G 体系结构的主要组件</p>
<ul>
<li>基站为 eNodeB，包含了原来 Node B 和 RNC 的功能</li>
<li>分组数据网络网关（P-GW）：给 UE 分配 IP 地址，并且保证 QoS 实施，也执行数据报封装/解封装</li>
<li>服务网关（S-GW）：所有 UE 流量将通过 S-GW 传递</li>
<li>移动性管理实体（MME）是核心控制网元，是控制面的核心，它代表位于它所控制单元中的 UE，执行连接和移动性管理</li>
<li>HSS 用于存储用户签约信息（号码归属地以及一些认证信息）的数据库，当手机通过 eNodeB 连上的时候，MME 会根据 HSS 的信息进行判断，选择数据面的 SGW 和 PGW</li>
</ul>
</li>
<li>
<p>手机直接通过 eNodeB 连接 SGW，连上核心网，并通过 PGW 连到 IP 网络</p>
</li>
</ul>
<h4 id="4G-网络协议">4G 网络协议</h4>
<ul>
<li>
<p>4G 网络的协议</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220903-4g-network-protocol.jpg" alt=""></p>
</li>
</ul>
<h5 id="控制面协议">控制面协议</h5>
<ul>
<li>
<p>当一个手机想上网的时候，先要连接 eNodeB，并通过 S1-MME 接口，请求 MME 对这个手机进行认证和鉴权</p>
</li>
<li>
<p>S1-MME 协议栈</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220904-S1-MME.jpg" alt=""></p>
</li>
<li>
<p>eNodeB 和 MME 之间的连接是 IP 网络，传输层的协议是 <code>SCTP</code>，更加适合移动网络</p>
<ul>
<li>
<p><strong>多宿主</strong>，SCTP 引入了联合（association）的概念，将多个接口、多条路径放到一个联合中来，当检测到一条路径失效时，协议就会通过另外一条路径来发送通信数据，应用程序不必知道发生了故障、恢复，从而提供更高的可用性和可靠性</p>
</li>
<li>
<p><strong>将一个联合分成多个流</strong>，一个联合中的所有流都是独立的，但均与该联合相关，每个流都给定了一个流编号，它被编码到 SCTP 报文中，通过联合在网络上传送，SCTP 的多个流不会相互阻塞</p>
</li>
<li>
<p><strong>四次握手</strong>，通过四次握手引入 Cookie 的概念来有效地防止 SYN 攻击</p>
<ul>
<li>客户机使用一个 <code>INIT</code> 报文发起一个连接</li>
<li>服务器使用一个 <code>INIT-ACK</code> 报文进行响应，其中包括了 Cookie</li>
<li>然后客户端就使用一个 <code>COOKIE-ECHO</code> 报文进行响应，其中包含了服务器所发送的 Cookie</li>
<li><strong>服务器为这个连接分配资源</strong>，并通过向客户机发送一个 <code>COOKIE-ACK</code> 报文对其进行响应</li>
</ul>
</li>
<li>
<p><strong>消息分帧</strong>，借鉴了 UDP 的机制，在数据传输中提供了消息分帧功能，当一端对一个套接字执行写操作时，可确保对等端读出的数据大小与此相同</p>
</li>
<li>
<p><strong>三次挥手</strong>，当一端关闭自己的套接字时，对等的两端全部关闭，将来任何一端都不允许再进行数据的移动</p>
</li>
</ul>
</li>
<li>
<p>MME 通过认证鉴权同意手机上网时，需建立一个数据面的数据通路，使用的是控制面的协议 <code>GTP-C</code>，协议基于 UDP 协议；数据通路分为两个隧道，一段是从 eNodeB 到 SGW，MME 通过 S1-MME 协议告诉 eNodeB 它是隧道的一端，通过 S11 告诉 SGW 它是隧道的另一端，第二段 SGW 通过 S11 协议知道自己是其中一端，并主动通过 S5 协议告诉 PGW 它是隧道的另一端</p>
<ul>
<li>GTP 头中由隧道 ID，还有序列号；通过序列号 GTP-C 可以实现可靠性，为每个输出信令消息分配一个依次递增的序列号，以确保按序传递并便于检测重复包，对于每个输出信令消息启动定时器，在定时器超时前未接收到响应消息则进行重发</li>
</ul>
</li>
</ul>
<h5 id="数据面协议">数据面协议</h5>
<ul>
<li>
<p>当数据通路建立，PGW 会给用户分配 IP 地址，使用这个地址连接 eNodeB，经过 S1-U 协议，通过第一段隧道到达 SGW，再从 SGW 经过 S8 协议，通过第二段隧道到达 PGW，然后通过 PGW 连接到互联网</p>
<blockquote>
<p>这个 IP 地址是隧道内部的 IP 地址，可类比为 IPsec 协议中的 IP 地址，这个 IP 地址由手机运营商管理</p>
</blockquote>
</li>
<li>
<p>数据面的协议都是通过 <code>GTP-U</code>，用户发出的包都由 GTP-U 隧道协议封装</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220904-GTP-U.jpg" alt=""></p>
</li>
<li>
<p>GTP-U 协议分为乘客协议、隧道协议、承载协议；乘客协议是用户发出的包，IP 是用户 IP，隧道协议里面有隧道 ID，不同的手机上线会建立不同的隧道，承载协议的 IP 地址是 SGW 和 PGW 的 IP</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220904-GTP-U-format.jpg" alt=""></p>
</li>
</ul>
<h5 id="上网流程">上网流程</h5>
<ol>
<li>
<p>用户在附近寻找基站 eNodeB，发送 Attach Request</p>
</li>
<li>
<p>eNodeB 将请求发给 MME</p>
</li>
<li>
<p>MME 对用户进行认证、鉴权等，通过之后开始分配隧道</p>
</li>
<li>
<p>MME 先告诉 SGW 要创建一个会话（Create Session），给 SGW 分配一个隧道 ID t1，并且请求 SGW 给自己也分配一个隧道 ID</p>
</li>
<li>
<p>SGW 向 PGW 请求建立一个会话，为 PGW 控制面分配一个隧道 ID t2，为 PGW 数据面分配一个隧道 ID t3，并且请求 PGW 给自己的控制面和数据面分配隧道 ID</p>
</li>
<li>
<p>PGW 使用自己的 ID t2 回复 SGW 创建会话成功，回复里面携带着给 SGW 控制面分配的隧道 ID t4 和数据面的隧道 ID t5，至此 SGW 和 PGW 直接的隧道建设完成</p>
</li>
<li>
<p>SGW 回复 MME  创建会话成功，回复里面有给 MME 分配隧道 ID t6，也有 SGW 给 eNodeB 分配的隧道 ID t7</p>
</li>
<li>
<p>MME 告诉 eNodeB：“后面的隧道建设完毕，SGW 给你分配的隧道 ID 是 t7，你也要给 SGW 分配一个隧道 ID”</p>
</li>
<li>
<p>eNodeB 告诉 MME 自己给 SGW 分配一个隧道 ID t8</p>
</li>
<li>
<p>MME 将 eNodeB 给 SGW 分配的隧道 ID t8 告知 SGW，从而前面的隧道也建设完毕，用户可通过数据通路上网</p>
<p><img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/20220904-surf-Internet.jpg" alt=""></p>
<blockquote>
<p>为什么要分 SGW 和 PGW 呢？</p>
<p>SGW 是本地运营商的设备，而 PGW 是用户所属的运营商的设备，例如异地上网时，用户和国外运营商的 SGW 会建立一个隧道，然后国外运营商的 SGW 和国内运营商的 PGW 建立一个隧道，用户就能够通过国内运营商的 PGW 上网，用户分配到的 IP 地址也是国内运营商的 PGW 负责（所以还是上不了推）</p>
</blockquote>
</li>
</ol>
<hr>
<p>参考</p>
<ul>
<li>趣谈网络协议</li>
<li>Web协议详解与抓包实战</li>
<li><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2011/09/restful.html">理解 RESTful 架构</a></li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">宵烛</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://night-candle.github.io/2021/02/04/cs-network-protocol/">http://night-candle.github.io/2021/02/04/cs-network-protocol/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">宵烛</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%AE%B9%E5%99%A8/">
                                    <span class="chip bg-color">容器</span>
                                </a>
                            
                                <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
                                    <span class="chip bg-color">计算机网络</span>
                                </a>
                            
                                <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">
                                    <span class="chip bg-color">网络协议</span>
                                </a>
                            
                                <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">
                                    <span class="chip bg-color">云计算</span>
                                </a>
                            
                                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                    <span class="chip bg-color">微服务</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/02/04/cs-network-socket/">
                    <div class="card-image">
                        
                        <img src="https://raw.githubusercontent.com/night-candle/figurebed/main/img/cover-watermelon.jpg" class="responsive-img" alt="网络编程原理与实践">
                        
                        <span class="card-title">网络编程原理与实践</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文从实践出发，从问题的角度对网络编程相关的知识点进行阐述。和代码、实验进行关联，引出理论或算法的实际意义
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-02-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%A7%91/" class="post-category">
                                    计科
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
                        <span class="chip bg-color">计算机网络</span>
                    </a>
                    
                    <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">
                        <span class="chip bg-color">网络协议</span>
                    </a>
                    
                    <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                    <a href="/tags/socket/">
                        <span class="chip bg-color">socket</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/01/28/hello-os/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="操作系统基础和开发实践">
                        
                        <span class="card-title">操作系统基础和开发实践</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文讲解了操作系统的相关基础知识，如加电自检、实模式、保护模式、内核加载，并从0开始实现一个简易操作系统
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-01-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%A7%91/" class="post-category">
                                    计科
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                        <span class="chip bg-color">操作系统</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('200')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 宵烛 Blog<br />'
            + '文章作者: 宵烛<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important; position: absolute;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2023</span>
            
            <a href="/about" target="_blank">宵烛</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">94.6k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "1";
                        var startDate = "25";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/night-candle" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1219303301@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
    <div id="jsi-flying-fish-container" class="nav-wrapper" style="margin: 0px; padding: 0px;"></div>
    <script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    
        <!-- <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script> -->
        <script src='/libs/mermaid/mermaid.min.js'></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize({theme: 'forest'});
          }
        </script>
    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
